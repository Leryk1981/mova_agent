**ТЗ «MOVA Agent — конкурентный прод‑уровень»**  
*(документ рассчитан на команду из 4‑5 разработчиков, QA и DevOps)*  

---

## 1. Цели проекта
| № | Цель | Критерий готовности |
|---|------|----------------------|
| 1 | Достичь полной типовой статической проверки кода (TypeScript) | 100 % исходных файлов — `.ts`, отсутствие дублирующих `.js`. |
| 2 | Обеспечить атомарную и надёжную запись эпизодов/доказательств | Запись в транзакционный файл + резервирование, тесты на отказ. |
| 3 | Реализовать расширяемый реестр драйверов (плагин‑модель) | API `registerDriver(name, factory)` и динамическая загрузка из `drivers/`. |
| 4 | Внедрить строгую политику и токен‑бюджет | `policy_engine` проверяет RBAC, rate‑limit, бюджет; покрытие тестами ≥ 90 %. |
| 5 | Непрерывная интеграция/деплой с полным покрытием тестов | GitHub Actions: lint → unit → integration → build → Docker image. |
| 6 | Предоставить официальные SDK (TS & Python) и MCP‑gateway | Публикация npm‑пакета и PyPI‑пакета, примеры использования. |
| 7 | Обеспечить масштабируемую продукционную инфраструктуру | Docker‑Compose + Helm‑чарты для k8s, авто‑скейлинг, мониторинг. |

---

## 2. Текущее состояние (вывод из репозитория)

| Компонент | Текущее реал. | Проблемы |
|-----------|----------------|----------|
| **Кодовая база** | Дублирование `.js` + `.ts`, `src/*` содержит основные модули. | Отсутствие строгой типизации, возможна рассинхрон. |
| **Валидация** | `src/ajv/ajv_loader.{js,ts}` — ручная загрузка схем, `Ajv` без автогенерации типов. | Низкая производительность, отсутствие compile‑time проверок. |
| **Эпизоды** | `src/episodes/episode_writer*` пишет JSON‑файлы напрямую. | Нет атомарности, возможна потеря данных при сбое. |
| **Обработчики** | `src/handlers/registry.{js,ts}` — статический маппинг. | Добавление нового драйвера требует правки кода и перезапуска. |
| **Политика** | `src/policy/policy_engine.{js,ts}` — базовая проверка. | Не поддерживает RBAC, rate‑limit, токен‑budget. |
| **Токен‑budget** | `src/telemetry/*` — частичная проверка, но без привязки к схеме. | Нет строгой схемы‑валидации и отчётов. |
| **CLI** | `src/ux/cli_interface.{js,ts}` выводит `human_ui`. | Нет единого лог‑фреймворка, смешивание каналов. |
| **Тесты** | Множество unit‑тестов, но нет интеграционных сцен. | Недостаточная проверка полного цикла (plan → interpreter → episodes). |
| **CI/CD** | Отсутствует. | Нет автоматической проверки, сборки Docker‑образа. |
| **Документация** | `README.md`, `MOVA_AGENT_ARCHITECTURE_v0.md` – только описание. | Нет API‑документации, примеров SDK. |

---

## 3. Требования к реализации

### 3.1 Функциональные
1. **Полный переход на TypeScript**  
   - Удалить все `.js` файлы, оставить только `.ts`.  
   - Настроить `tsconfig.json` (target ES2022, strict, noImplicitAny).  

2. **Генерация типов из JSON‑Schema**  
   - Инструмент `json-schema-to-typescript`.  
   - Скрипт `npm run gen:types` → `src/types/generated/*.d.ts`.  

3. **Атомарная запись эпизодов**  
   - Запись в временный файл `*.tmp.json` → `fs.renameSync`.  
   - Включить резервный каталог `episodes/_backup`.  

4. **Плагин‑модель драйверов**  
   - Директория `src/drivers/` с `index.ts` экспортирующим `registerDriver`.  
   - API: `registerDriver(name: string, driverFactory: () => Driver)`.  
   - Динамический импорт (`import()`) при первом использовании.  

5. **Расширенный policy‑engine**  
   - Поддержка ролей (`admin, user, service`).  
   - Rate‑limit (calls per minute) и токен‑budget (чтение из `schemas/ds.mova_token_budget_contract_v0.schema.json`).  
   - Политика описывается в `configs/instruction_profile.default.json`.  

6. **CI/CD**  
   - GitHub Actions: `lint`, `test`, `build`, `docker`.  
   - Dockerfile (multi‑stage): сборка TS → `node:18-alpine`.  
   - Docker‑Compose для локального запуска (agent + PostgreSQL для логов).  

7. **SDK**  
   - **npm‑пакет** `mova-agent-sdk` (TypeScript).  
   - **Python‑пакет** `mova-agent-sdk-py` (pydantic‑модели, HTTP‑клиент).  

8. **MCP‑gateway**  
   - Express‑сервер (`mcp-gateway/index.ts`) → аутентификация JWT, роут `/tools/:toolId`.  
   - Прокси‑вызов к `MOVA‑Agent` через REST (POST `/run`).  

9. **Мониторинг**  
   - Prometheus‑метрики (`process_cpu_seconds_total`, `agent_requests_total`).  
   - Loki/Grafana для логов.  

### 3.2 Нефункциональные
| Требование | Показатели |
|------------|------------|
| **Производительность** | < 10 мс на валидацию схемы, < 50 мс на выполнение шага (без I/O). |
| **Надёжность** | 99.9 % успеваемости записи эпизода, автоматическое восстановление из backup. |
| **Безопасность** | JWT‑подпись, CSP, защита от инъекций в `restricted_shell`‑драйвере. |
| **Масштабируемость** | Возможность горизонтального масштабирования через k8s (stateless). |
| **Логи/Трассировка** | Полный набор полей `global.text_channel_catalog_v1.json`. |
| **Совместимость** | Node ≥ 18, TypeScript ≥ 5.0, поддержка Windows/Linux/macOS. |

---

## 4. Архитектурный дизайн (текстовое представление)

```
+-------------------+          +-------------------+          +-------------------+
|   CLI / UI        |  <----> |   REST API (MCP) |  <---->  |   Agent Core      |
| (src/ux)          |          | (Express)         |          | (interpreter)    |
+-------------------+          +-------------------+          +-------------------+
        ^                            ^                               |
        |                            |                               |
        |   +------------------------+-------------------------------+
        |   |                        |                               |
        v   v                        v                               v
+-------------------+   +-------------------+   +-------------------+
|  Policy Engine    |   |  Driver Factory   |   |  Episode Writer   |
| (src/policy)      |   | (src/drivers)    |   | (src/episodes)   |
+-------------------+   +-------------------+   +-------------------+
        ^                        ^                         ^
        |                        |                         |
        |   +--------------------+-------------------------+
        |   |                                          |
        v   v                                          v
+-------------------+   +-------------------+   +-------------------+
|  Ajv Schema Loader|   |  Token Budget    |   |  Logging (global) |
| (src/ajv)         |   | (src/telemetry) |   | (src/logging)     |
+-------------------+   +-------------------+   +-------------------+
```

- **CLI/UX** собирает входные данные, формирует `env.mova_agent_request_v1`.  
- **MCP‑gateway** обеспечивает аутентификацию и проксирует запросы к ядру.  
- **Policy Engine** проверяет роль, rate‑limit, токен‑budget.  
- **Driver Factory** динамически подгружает нужный драйвер (http, shell, db, mcp_proxy).  
- **Interpreter** последовательно исполняет шаги, используя AJV‑валидаторы.  
- **Episode Writer** атомарно сохраняет эпизоды и доказательства.  
- **Logging** пишет в каналы `human_ui`, `model_instruction`, `system_log`.  

---

## 5. План работы (разбивка на спринты)

| Спринт | Длительность | Основные задачи | Deliverable |
|--------|--------------|-----------------|-------------|
| **S1** | 2 недели | - Перевести весь код в TS.<br>- Настроить `tsconfig`, `eslint`, `prettier`.<br>- Удалить `.js`. | Репозиторий чистый TS, сборка `npm run build`. |
| **S2** | 2 недели | - Генерация типов из схем.<br>- Интеграция в CI (`npm run gen:types`). | `src/types/generated/*.d.ts` в репозитории. |
| **S3** | 3 недели | - Реализовать атомарную запись эпизодов.<br>- Добавить backup‑механизм.<br>- Тесты отказоустойчивости. | Надёжный `episode_writer`. |
| **S4** | 3 недели | - Плагин‑модель драйверов (директория `src/drivers`).<br>- Реализовать 2 новых драйвера (PostgreSQL, GraphQL). | Динамическое подключение драйверов. |
| **S5** | 3 недели | - Полный `policy_engine` (RBAC, rate‑limit, токен‑budget).<br>- Тесты покрытие ≥ 90 %. | Защищённый слой политики. |
| **S6** | 2 недели | - CI/CD (GitHub Actions) + Dockerfile.<br>- Docker‑Compose для локального dev. | Автоматический build & test. |
| **S7** | 2 недели | - MCP‑gateway (JWT, роуты).<br>- SDK (npm + PyPI). | Публичные API‑пакеты. |
| **S8** | 2 недели | - Мониторинг (Prometheus + Loki).<br>- Helm‑чарты для k8s. | Готово к прод‑деплою. |
| **S9** | 1 неделя | - Финальная документация (API, SDK, deployment).<br>- Обучение команды. | Полный набор docs. |
| **Total** | **20 недель** (~5 месяцев) |

---

## 6. Оценка ресурсов и бюджета

| Роль | Человек‑недели | Оклад (руб) | Примерные затраты |
|------|----------------|--------------|-------------------|
| Senior TS Engineer | 8 | 200 000 | 1 600 000 |
| Backend Engineer (Node/Go) | 6 | 180 000 | 1 080 000 |
| Security Engineer | 4 | 220 000 | 880 000 |
| QA Engineer | 5 | 150 000 | 750 000 |
| DevOps Engineer | 3 | 190 000 | 570 000 |
| Technical Writer | 2 | 130 000 | 260 000 |
| **Итого** | **28** | — | **≈ 5 500 000 RUB** |

*Включает подготовку инфраструктуры, лицензии (npm/PyPI), облачные ресурсы для тестов (AWS/GCP).*

---

## 7. Критерии приёмки (Definition of Done)

| № | Критерий |
|---|----------|
| 1 | Полный набор тестов (unit + integration) покрывает ≥ 90 % кода. |
| 2 | Docker‑образ размер < 150 MB, запускается без ошибок. |
| 3 | API‑gateway проходит тесты безопасности (OWASP ZAP). |
| 4 | Генерируемый SDK публикуется в npm и PyPI, пример проекта проходит CI. |
| 5 | Документация покрывает архитектуру, API, пример запуска, мониторинг. |
| 6 | Производительность‑тест показывает < 10 ms валидацию схемы, < 50 ms step. |
| 7 | Система логов и метрик успешно интегрирована в Grafana/Loki. |
| 8 | Проект может быть развернут в k8s через Helm‑чарт без ручных правок. |

---

## 8. Риски и mitigation

| Риск | Вероятность | Влияние | Митигирование |
|------|-------------|---------|---------------|
| **Сложность миграции к TS** | Средняя | Среднее | Пошаговый перенос, покрытие тестами до рефакторинга. |
| **Непредвиденные схемы** | Низкая | Высокое | Автоматическая генерация типов и тесты на схему. |
| **Безопасность драйверов** | Средняя | Высокое | White‑list команд, sandbox для `restricted_shell`. |
| **Нехватка специалистов** | Низкая | Среднее | Подключить внешних консультантов по security и CI. |
| **Стабильность MCP‑gateway** | Средняя | Среднее | Интеграционные тесты с имитацией нагрузки. |

---

## 9. Заключение
Данный ТЗ описывает конкретный, пошаговый план трансформации текущего **MOVA Agent** в **прод‑уровневый продукт**, готовый к использованию в корпоративных сценариях, где критичны безопасность, аудит и детерминированность. Выполнение всех пунктов позволит занять нишу **on‑prem интеллектуальных агентов**, конкурировать с решениями крупных провайдеров за счёт открытой архитектуры, полной трассируемости и гибкой интеграции через MCP‑gateway.

**Следующий шаг:** согласовать план спринтов с командой, сформировать backlog в системе управления задачами (Jira/ClickUp) и стартовать Sprint 1 – миграция на TypeScript.