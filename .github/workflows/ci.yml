name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Verify compatibility matrix
        run: npm run verify:compat

      - name: Lint
        run: npm run lint

      - name: Format (check)
        run: npm run format:check

      - name: Check structure
        run: npm run check:structure

      - name: Check docs
        run: npm run check:docs

      - name: Test
        run: npm test

      - name: Build SDK CLI
        run: npm run build:sdk-cli

      - name: Integration smoke tests
        run: npm run test:integration

  docker-build:
    runs-on: ubuntu-22.04
    needs: build
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t mova-agent:ci .

      - name: Verify image runs (CLI help)
        run: docker run --rm mova-agent:ci node build/tools/mova-agent.js --help
